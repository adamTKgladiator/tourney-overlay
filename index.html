<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TK Tournament Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-image: url('./Assets/BG.png');
            background-size: cover;
            background-attachment: fixed;
            background-position: center;
            background-color: #111;
            color: #fff;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .dashboard-container {
            background: rgba(0, 0, 0, 0.85);
            border: 2px solid #9146FF;
            border-radius: 15px;
            padding: 40px;
            width: 900px;
            box-shadow: 0 0 30px rgba(145, 70, 255, 0.3);
            text-align: center;
        }

        .logo-title {
            font-size: 3rem;
            font-weight: 800;
            color: #fff;
            text-transform: uppercase;
            text-shadow: 0 0 10px #9146FF, 0 0 20px #9146FF;
            margin-bottom: 10px;
            letter-spacing: 2px;
        }

        .subtitle {
            font-size: 1.1rem;
            color: #a970ff;
            margin-bottom: 40px;
            letter-spacing: 1px;
        }

        .grid-menu {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .menu-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
            border: 1px solid #444;
            border-radius: 10px;
            padding: 25px;
            text-decoration: none;
            color: #ccc;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 180px;
        }

        .menu-card:hover {
            transform: translateY(-5px);
            background: linear-gradient(135deg, rgba(145, 70, 255, 0.2) 0%, rgba(145, 70, 255, 0.1) 100%);
            border-color: #9146FF;
            color: #fff;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }

        .menu-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #9146FF;
            transition: transform 0.3s;
        }

        .menu-card:hover .menu-icon {
            transform: scale(1.1);
            color: #fff;
            text-shadow: 0 0 10px #9146FF;
        }

        .menu-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .menu-desc {
            font-size: 0.8rem;
            color: #888;
            transition: color 0.3s;
        }

        .menu-card:hover .menu-desc {
            color: #ccc;
        }

        .admin-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .viewer-section {
            grid-column: span 3;
            margin-bottom: 10px;
        }

        .viewer-card {
            background: linear-gradient(135deg, rgba(145, 70, 255, 0.15) 0%, rgba(60, 20, 120, 0.5) 100%);
            border: 1px solid #9146FF;
            height: 120px;
            flex-direction: row;
            gap: 30px;
        }

        .viewer-card .menu-icon {
            font-size: 2.5rem;
            margin-bottom: 0;
        }

        .viewer-card .menu-title {
            font-size: 1.5rem;
        }

        .utility-links {
            margin-top: 30px;
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .sm-link {
            color: #666;
            text-decoration: none;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: color 0.2s;
        }

        .sm-link:hover {
            color: #9146FF;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            color: white;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #9146FF;
            box-shadow: 0 0 10px rgba(145, 70, 255, 0.3);
        }

        .btn-primary:hover {
            background: #8234ea;
            box-shadow: 0 0 15px rgba(145, 70, 255, 0.5);
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #333;
            border: 1px solid #ff4444;
            color: #ff4444;
        }

        .btn-danger:hover {
            background: #ff4444;
            color: white;
        }
    </style>
</head>

<body>

    <div class="dashboard-container">
        <div class="logo-title"><i class="fas fa-gamepad"></i> TK TOURNAMENTS</div>
        <div class="subtitle">Tournament Overlay Command Center</div>

        <div class="grid-menu">
            <!-- Viewer Section -->
            <a href="upcoming_matches.html" class="menu-card viewer-section viewer-card">
                <i class="fas fa-tv menu-icon"></i>
                <div style="text-align:left">
                    <div class="menu-title">Viewer Overlay</div>
                    <div class="menu-desc">Match schedule and upcoming games display</div>
                </div>
            </a>

            <!-- Admin Tools -->
            <a href="bracket_v2.html" class="menu-card">
                <i class="fas fa-sitemap menu-icon"></i>
                <div class="menu-title">Bracket V2</div>
                <div class="menu-desc">Main bracket view (Connected)</div>
            </a>

            <a href="schedule_matches_v2.html" class="menu-card">
                <i class="fas fa-calendar-alt menu-icon"></i>
                <div class="menu-title">Scheduler</div>
                <div class="menu-desc">Manage times & sets winners</div>
            </a>

            <a href="player_management.html" class="menu-card">
                <i class="fas fa-users menu-icon"></i>
                <div class="menu-title">Players</div>
                <div class="menu-desc">Add & edit tournament roster</div>
            </a>

            <a href="schedule_matches1.html" class="menu-card">
                <i class="fas fa-edit menu-icon"></i>
                <div class="menu-title">Custom Scheduler</div>
                <div class="menu-desc">Manual match scheduling interface</div>
            </a>

            <a href="casino_intro.html" class="menu-card" style="border-color: var(--gold);">
                <i class="fas fa-star menu-icon" style="color: var(--gold);"></i>
                <div class="menu-title">Intro Screen</div>
                <div class="menu-desc">Animated landing/intro page</div>
            </a>
        </div>

        <!-- Bracket Control Section -->
        <div class="admin-controls" style="margin-top:20px; padding-top:20px; border-top:1px solid #444;">
            <div class="menu-title" style="margin-bottom:15px; color:#9146FF;">BRACKET ACTIONS</div>
            <div style="display:flex; gap:15px; justify-content:center;">
                <button class="btn btn-primary" onclick="generateBracket()">
                    <i class="fas fa-magic"></i> Generate New Bracket
                </button>
                <button class="btn btn-danger" onclick="clearAllMatches()">
                    <i class="fas fa-trash-alt"></i> Clear Database
                </button>
            </div>
            <div id="statusMessage" style="color:#aaa; margin-top:10px; font-size:0.9rem; height:20px"></div>
        </div>
        <div class="utility-links">
            <a href="debug_matches.html" class="sm-link"><i class="fas fa-bug"></i> Debug View</a>
            <a href="#" class="sm-link"><i class="fas fa-cog"></i> Settings (Coming Soon)</a>
        </div>

    </div>
    </div>

    <script>
        // --- CONSTANTS ---
        // Bracket Structure for 8-Player Double Elimination
        const BRACKET_STRUCTURE = {
            winners: [
                { name: 'ROUND 1', count: 4 },
                { name: 'WINNERS SEMI-FINAL', count: 2 },
                { name: 'WINNERS FINAL', count: 1 },
                { name: 'GRAND FINAL', count: 1 }
            ],
            losers: [
                { name: 'LOSERS ROUND 1', count: 2 },
                { name: 'LOSERS ROUND 2', count: 2 },
                { name: 'LOSERS ROUND 3', count: 1 },
                { name: 'LOSERS FINAL', count: 1 }
            ]
        };

        const SUPABASE_URL = 'https://ofkzngjawgimpdwuycqd.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_A22ZrmtTDJYaHCI-HCCRjA_jYhTKJ-x';

        // --- BRACKET LOGIC ---

        async function generateBracket() {
            if (!confirm('WARNING: This will WIPE all existing matches and generate a new bracket. Continue?')) return;

            setStatus('Loading players...', 'info');

            try {
                // 1. Load Players
                const res = await fetch(`${SUPABASE_URL}/rest/v1/players?select=*&order=name.asc`, {
                    headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` }
                });
                if (!res.ok) throw new Error('Failed to load players');
                const players = await res.json();

                if (players.length < 8) return setStatus('Need at least 8 players!', 'error');

                setStatus('Clearing old data...', 'info');
                await clearExistingMatches();

                setStatus('Generating bracket...', 'info');

                const shuffled = [...players].sort(() => Math.random() - .5);
                const newMatches = [];

                // Helper to push match
                const createMatch = (round, pos, p1, p2) => {
                    newMatches.push({
                        id: crypto.randomUUID(),
                        round: round,
                        bracket_position: pos,
                        player1_id: p1 ? p1.id : null,
                        player2_id: p2 ? p2.id : null,
                        status: (p1 && p2) ? 'scheduled' : 'unscheduled',
                        created_at: new Date().toISOString()
                    });
                };

                // 1. Create Round 1 Matches (Seeds)
                createMatch('ROUND 1', 1, shuffled[0], shuffled[1]);
                createMatch('ROUND 1', 2, shuffled[2], shuffled[3]);
                createMatch('ROUND 1', 3, shuffled[4], shuffled[5]);
                createMatch('ROUND 1', 4, shuffled[6], shuffled[7]);

                // 2. Create Placeholder Matches for Winners
                BRACKET_STRUCTURE.winners.slice(1).forEach(r => {
                    for (let i = 1; i <= r.count; i++) createMatch(r.name, i, null, null);
                });

                // 3. Create Placeholder Matches for Losers
                BRACKET_STRUCTURE.losers.forEach(r => {
                    for (let i = 1; i <= r.count; i++) createMatch(r.name, i, null, null);
                });

                // Batch insert
                for (let m of newMatches) {
                    await fetch(`${SUPABASE_URL}/rest/v1/matches`, {
                        method: 'POST',
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'resolution=merge-duplicates'
                        },
                        body: JSON.stringify(m)
                    });
                }

                setStatus('Bracket Generated Successfully!', 'success');

            } catch (e) {
                console.error(e);
                setStatus('Generation failed: ' + e.message, 'error');
            }
        }

        async function clearAllMatches() {
            if (!confirm('Are you sure you want to delete ALL matches?')) return;
            setStatus('Clearing...', 'info');
            try {
                await clearExistingMatches();
                setStatus('Database Cleared', 'success');
            } catch (e) {
                setStatus('Clear failed', 'error');
            }
        }

        async function clearExistingMatches() {
            // Get all IDs first
            const res = await fetch(`${SUPABASE_URL}/rest/v1/matches?select=id`, {
                headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` }
            });
            const data = await res.json();

            // Delete one by one
            for (let m of data) {
                await fetch(`${SUPABASE_URL}/rest/v1/matches?id=eq.${m.id}`, {
                    method: 'DELETE',
                    headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` }
                });
            }
        }

        function setStatus(msg, type) {
            const el = document.getElementById('statusMessage');
            el.textContent = msg;
            el.style.color = type === 'error' ? '#ff4444' : (type === 'success' ? '#00ff1a' : '#aaa');

            if (type === 'success') {
                setTimeout(() => el.textContent = '', 3000);
            }
        }
    </script>
</body>

</html>